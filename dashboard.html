<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SafeCare CRM - Dashboard</title>
    <link rel="icon" href="data:,">
    <link rel="stylesheet" href="css/shared.css">
    <link rel="stylesheet" href="css/dashboard.css">
    <link rel="stylesheet" href="css/quill.css">
    <link rel="stylesheet" href="css/quill-custom.css">
</head>
<body>
    <div class="app-header">
        <div class="app-header-left">
            <div class="app-logo">üõ°Ô∏è</div>
            <div class="app-title">
                <h1>SafeCare CRM</h1>
            </div>
        </div>
        <div class="app-header-right">
            <div class="user-info">
                <div class="user-name" id="currentUserName">User</div>
                <div class="user-role" id="currentUserRole">User</div>
            </div>
            <button class="btn-logout" onclick="logout()">Sign Out</button>
        </div>
    </div>

    <div class="nav-tabs">
        <button class="nav-tab active" onclick="showTab('dashboard')">Dashboard</button>
        <button class="nav-tab" onclick="showTab('contacts')">Contacts</button>
        <button class="nav-tab" onclick="showTab('communications')">Communications</button>
        <button class="nav-tab" onclick="showTab('documents')">Documents</button>
        <button class="nav-tab" onclick="showTab('incidents')">Incident Reports</button>
        <button class="nav-tab" id="adminTab" style="display:none;" onclick="showTab('admin')">Admin Panel</button>
        <button class="nav-tab" onclick="showTab('settings')">Settings</button>
    </div>

    <div class="content">
        <!-- Tab Containers - Content rendered by modules -->
        <div id="dashboard" class="tab-content active"></div>
        <div id="contacts" class="tab-content"></div>
        <div id="communications" class="tab-content"></div>
        <div id="documents" class="tab-content"></div>
        <div id="incidents" class="tab-content"></div>
        <div id="admin" class="tab-content"></div>
        <div id="settings" class="tab-content"></div>
    </div>

    <script src="config.js"></script>
    <script src="auth.js"></script>
    <script src="crm.js"></script>
    <script src="encryption-local.js"></script>
    <script src="encryption-kms.js"></script>
    <script src="encryption.js"></script>

    
    <!-- Module Scripts: NOTE the order ‚Äî communications-storage must load BEFORE the communications module -->
    <script src="modules/quill-editor.js"></script>
    <script src="modules/dashboard-tab.js"></script>
    <script src="modules/contacts-tab.js"></script>
    <script src="modules/admin-tab.js"></script>
    <script src="modules/settings-tab.js"></script>

    <!-- communications-storage.js must be available before modules/communications-tab.js -->
    <script src="communications-storage.js"></script>

    <script src="modules/communications-tab.js"></script>
    <script src="modules/documents-tab.js"></script>
    <script src="modules/incidents-tab.js"></script>
    
    <script>
        let currentUser = null;
        let CONFIG = window.CRM_CONFIG;

        window.addEventListener('DOMContentLoaded', async () => {
            currentUser = checkAuth();
            if (!currentUser) {
                return;
            }
            
            // Make currentUser available globally for modules
            window.currentUser = currentUser;
            
            // Initialize encryption from login credentials
            await initializeEncryption();
            
            await initDashboard();
        });

        async function initializeEncryption() {
            try {
                console.log('Initializing encryption...');
                
                const loginType = currentUser.loginType || 'email';
                const credential = currentUser.credential || null;
                
                await EncryptionService.initializeFromLogin(
                    currentUser.email,
                    loginType,
                    credential
                );
                
                console.log('‚úì Encryption ready:', EncryptionService.getMetadata());
                
                // Clear credential from memory after key derivation
                if (currentUser.credential) {
                    delete currentUser.credential;
                    localStorage.setItem('userSession', JSON.stringify(currentUser));
                }
            } catch (error) {
                console.error('Failed to initialize encryption:', error);
                alert('Encryption initialization failed. Some features may not work correctly.');
            }
        }

        async function initDashboard() {
            console.log('Initializing dashboard for:', currentUser.email);
            
            document.getElementById('currentUserName').textContent = currentUser.name;
            document.getElementById('currentUserRole').textContent = 
                currentUser.role === 'admin' ? 'Administrator' : 'User';
            
            if (currentUser.role === 'admin') {
                document.getElementById('adminTab').style.display = 'block';
            }

            await DashboardTab.render();
        }

        async function showTab(tabName, event) {
            // Update tab content visibility
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            
            // Update nav tab styling
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            
            // Find and activate the correct nav tab
            const navTabs = document.querySelectorAll('.nav-tab');
            navTabs.forEach(tab => {
                if (tab.getAttribute('onclick')?.includes(`'${tabName}'`)) {
                    tab.classList.add('active');
                }
            });
    
            // Render the tab module
            const moduleName = tabName.charAt(0).toUpperCase() + tabName.slice(1) + 'Tab';
            if (window[moduleName] && typeof window[moduleName].render === 'function') {
                await window[moduleName].render();
            }
        }

        function updateConfigStatus() {
            const statusEl = document.getElementById('configStatus');
            if (!statusEl) return;

            const checks = [
                { name: 'Google Client ID', value: CONFIG.GOOGLE_CLIENT_ID },
                { name: 'GitHub Username', value: CONFIG.GITHUB_USERNAME },
                { name: 'GitHub Repository', value: CONFIG.GITHUB_REPO },
                { name: 'GitHub Token', value: CONFIG.GITHUB_TOKEN }
            ];

            const html = checks.map(check => {
                const status = check.value && check.value !== '' ? '‚úÖ' : '‚ùå';
                const color = check.value && check.value !== '' ? 'var(--success)' : 'var(--danger)';
                return `<p style="margin: 8px 0;"><span style="color: ${color}">${status}</span> ${check.name}: ${check.value && check.value !== '' ? 'Configured' : 'Missing'}</p>`;
            }).join('');

            statusEl.innerHTML = html;
        }
    </script>
</body>
</html>
